<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Baklava - Media Request Manager</title>
</head>

<body>
    <div id="BaklavaConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <div style="text-align: center; margin-bottom: 20px;">
                    <!-- Plugin logo loaded from GitHub (plugins can't serve static files via HTTP GET) -->
                    <img src="https://raw.githubusercontent.com/j4ckgrey/Baklava/main/Baklava.png" alt="Baklava Logo"
                        style="max-width: 200px; height: auto; border-radius: 8px;"
                        onerror="this.style.display='none';">
                </div>
                <h2 style="text-align: center;">Baklava - Media Request Manager</h2>
                <h3 style="text-align: center;">Plugin Settings</h3>



                <!-- API Keys -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">API Keys</h4>

                    <div style="margin-bottom: 16px;">
                        <label for="tmdbApiKey" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">TMDB
                            API Key (required for Modals Metadata)</label>
                        <input id="tmdbApiKey" type="text" placeholder="Enter TMDB API Key"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                    </div>

                    <h5 style="color: #ddd; margin-bottom: 12px;">Debrid Services</h5>
                    <p style="margin: 0 0 12px 0; font-size: 12px; color: #999;">
                        Configure API keys for your debrid services. Only fill in the services you use.
                    </p>

                    <div style="margin-bottom: 12px;">
                        <label for="realDebridApiKey"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">RealDebrid API
                            Key</label>
                        <input id="realDebridApiKey" type="text" placeholder="Enter RealDebrid API Key"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="torboxApiKey"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">TorBox API Key</label>
                        <input id="torboxApiKey" type="text" placeholder="Enter TorBox API Key"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="alldebridApiKey"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">AllDebrid API
                            Key</label>
                        <input id="alldebridApiKey" type="text" placeholder="Enter AllDebrid API Key"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="premiumizeApiKey"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Premiumize API
                            Key</label>
                        <input id="premiumizeApiKey" type="text" placeholder="Enter Premiumize API Key"
                            style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                    </div>
                </div>

                <!-- Search Filter Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Search Settings</h4>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="forceTVClientLocalSearch" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Force Local Search for TV Clients</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, all TV clients will only see local library results. This is useful for
                            restricting external search on shared/public servers.
                        </p>
                    </div>
                </div>

                <!-- Request Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Request Settings</h4>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="enableAutoImport" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Auto Import</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, non-admin users will be able to "Import" directly instead of "Request" for
                            items in the library.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="disableModal" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Disable Modal</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            Directly open items on click when Auto Import is enabled (bypasses details modal).
                        </p>
                    </div>
                </div>

                <!-- Debrid Integration Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Debrid Integration (Stream MediaInfo)</h4>

                    <div
                        style="margin-bottom: 16px; padding: 12px; background: rgba(30,144,255,0.1); border-left: 3px solid #1e90ff; border-radius: 4px;">
                        <p style="margin: 0; font-size: 13px; color: #bbb; line-height: 1.5;">
                            <strong style="color: #1e90ff;">ðŸ“Œ What is this?</strong><br>
                            Configure your debrid service API to fetch audio and subtitle metadata for cached streams.
                            This allows you to see codec information, audio tracks, and subtitles
                            <strong>before</strong> playing,
                            without triggering any downloads to your account.
                        </p>
                    </div>





                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;">
                            <input id="enableDebridMetadata" type="checkbox" style="margin-right: 8px;" disabled>
                            <span style="color:#ddd;">Enable Cached Debrid Streams (Disabled)</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999; line-height: 1.5;">
                            Fetches audio/subtitle information from your debrid service's <strong>shared cache</strong>
                            without downloading anything.
                            The streams remain in the public cache and are <strong>NOT added to your account</strong>
                            until you actually press play.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px; margin-left: 28px;">
                        <label style="display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;">
                            <input id="fetchCachedMetadataPerVersion" type="checkbox" style="margin-right: 8px;"
                                disabled>
                            <span style="color:#ddd;">Fetch Cached Metadata Per Version (Disabled)</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999; line-height: 1.5;">
                            If active, metadata is fetched only for the selected version (faster load).<br>
                            If disabled, all cached streams are fetched at once.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;">
                            <input id="enableFallbackProbe" type="checkbox" style="margin-right: 8px;" disabled>
                            <span style="color:#ddd;">Enable Non-Cached Debrid Streams (Disabled)</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999; line-height: 1.5;">
                            If cached metadata lookup fails, this will trigger a traditional analysis.
                            This <strong>WILL download/cache the stream to your debrid account</strong> to extract
                            metadata, even if you never watch it.
                            This can clutter your account with unwatched files.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px; margin-left: 28px;">
                        <label style="display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;">
                            <input id="fetchAllNonCachedMetadata" type="checkbox" style="margin-right: 8px;" disabled>
                            <span style="color:#ddd;">Fetch All Non-Cached Metadata (Disabled)</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #d35400; line-height: 1.5;">
                            <strong>Costly!</strong> Enforces downloading ALL non-cached streams to probe metadata.<br>
                            If disabled (recommended), probing happens only per selected version.
                        </p>
                    </div>


                </div>

                <!-- External Subtitles Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">External Subtitles</h4>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;">
                            <input id="enableExternalSubtitles" type="checkbox" style="margin-right: 8px;" disabled>
                            <span style="color:#ddd;">Enable External Subtitles (Disabled)</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            This feature is currently disabled for stability.
                        </p>
                    </div>
                </div>



                <!-- Cache Management Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Cache Management</h4>

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <p style="margin: 0; font-size: 13px; color: #bbb;">Manage cached MediaInfo and streams from
                            Debrid services.
                        </p>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="cacheServiceSelect"
                                style="padding: 6px 12px; border-radius: 4px; border: 1px solid #444; background: #111; color: #fff; font-size: 13px;">
                                <option value="">All Services</option>
                            </select>
                            <button id="probeAllCacheBtn"
                                style="display: none; padding: 6px 12px; border: none; background: #2ecc71; color: white; border-radius: 4px; cursor: pointer; font-size: 13px;">Probe
                                All</button>
                            <button id="clearAllCacheBtn"
                                style="padding: 6px 12px; border: none; background: #e74c3c; color: white; border-radius: 4px; cursor: pointer; font-size: 13px;">Clear
                                Cache</button>
                        </div>
                    </div>

                    <div id="cacheListContainer"
                        style="height: 300px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 8px;">
                        <div style="text-align: center; color: #888; padding: 10px;">Loading cache...</div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div id="deleteConfirmModal"
                    style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div
                        style="background: #222; padding: 20px; border-radius: 8px; width: 400px; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                        <h3 style="margin-top: 0; color: #e74c3c;">Delete All Cache?</h3>
                        <p style="color: #ddd; font-size: 14px; line-height: 1.5;">
                            This will delete all cached stream metadata for <strong>ALL items</strong>.<br>
                            It will also <strong>DELETE the downloaded files from your Debrid Service</strong> to clean
                            up
                            your account.<br><br>
                            Baklava will need to re-fetch metadata (and potentially re-download files) next
                            time.<br><br>
                            Are you sure?
                        </p>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button id="cancelDeleteBtn"
                                style="padding: 8px 16px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button id="confirmDeleteBtn"
                                style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">Yes,
                                Delete All</button>
                        </div>
                    </div>
                </div>

                <!-- Probe Confirmation Modal -->
                <div id="probeConfirmModal"
                    style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div
                        style="background: #222; padding: 20px; border-radius: 8px; width: 400px; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                        <h3 style="margin-top: 0; color: #1e90ff;">Probe All Cache?</h3>
                        <p style="color: #ddd; font-size: 14px; line-height: 1.5;">
                            This will scan all cached items, verify Debrid links, and perform <strong>FFprobe
                                analysis</strong> on audio/subtitle streams.<br><br>
                            This operation <strong>may take a long time</strong> depending on your cache size.<br>
                            It runs in the background.<br><br>
                            Are you sure?
                        </p>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button id="cancelProbeBtn"
                                style="padding: 8px 16px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button id="confirmProbeBtn"
                                style="padding: 8px 16px; background: #1e90ff; color: white; border: none; border-radius: 4px; cursor: pointer;">Yes,
                                Probe All</button>
                        </div>
                    </div>
                </div>



                <!-- Catalogs Management -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h4 style="margin: 0; color: #1e90ff;">Catalogs</h4>
                            <!-- Hamburger Filter Menu -->
                            <div style="position: relative;">
                                <button id="catalogFilterBtn" type="button"
                                    style="background: transparent; border: 1px solid #444; color: #ccc; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 16px;"
                                    title="Filter catalogs">â˜°</button>
                                <div id="catalogFilterDropdown"
                                    style="display: none; position: absolute; top: 100%; left: 0; background: #222; border: 1px solid #444; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100; min-width: 140px; margin-top: 4px;">
                                    <button type="button" data-filter="all"
                                        style="display: block; width: 100%; padding: 8px 12px; background: transparent; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 13px;"
                                        class="catalog-filter-option active">All</button>
                                    <button type="button" data-filter="imported"
                                        style="display: block; width: 100%; padding: 8px 12px; background: transparent; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 13px;"
                                        class="catalog-filter-option">Imported</button>
                                    <button type="button" data-filter="not-imported"
                                        style="display: block; width: 100%; padding: 8px 12px; background: transparent; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 13px;"
                                        class="catalog-filter-option">Not Imported</button>
                                </div>
                            </div>
                            <span id="catalogFilterLabel"
                                style="font-size: 11px; color: #888; margin-left: 4px;">(All)</span>
                        </div>

                        <div style="flex: 1; display: flex; justify-content: center; margin: 0 20px;">
                            <input id="catalogSearchInput" type="text" placeholder="Search catalogs..."
                                style="width: 100%; max-width: 300px; padding: 6px 12px; border: 1px solid #444; border-radius: 4px; background: #111; color: white; font-size: 13px;" />
                        </div>

                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 12px; color: #999;">Max items:</label>
                            <input id="catalogsMaxItems" type="number" min="1" max="500" value="100" style="width: 60px; padding: 4px 8px; border: 1px solid #1e90ff; 
                                          border-radius: 4px; background: rgba(30,144,255,0.1); 
                                          color: white; font-size: 13px;" />
                            <button id="catalogsRefreshBtn" type="button"
                                style="padding: 6px 12px; border: none; background: #1e90ff; color: white; border-radius: 4px; cursor: pointer; font-size: 13px;">Refresh</button>
                        </div>
                    </div>
                    <p style="margin: 0 0 12px 0; font-size: 12px; color: #999;">
                        Manage aiostreams catalogs from Gelato. Create collections or import items directly to your
                        library.
                    </p>
                    <div id="catalogsLoading" style="display: none; text-align: center; padding: 20px; color: #888;">
                        Loading catalogs...
                    </div>
                    <div id="catalogsError"
                        style="display: none; padding: 10px; color: #e74c3c; background: rgba(231,76,60,0.1); border-radius: 4px;">
                    </div>
                    <div id="catalogsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- UI Settings -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; box-sizing: border-box;">
                    <h4 style="margin-top: 0; color: #1e90ff;">UI Settings</h4>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="enableBaklavaUI" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Baklava UI Injection</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            Injects custom UI scripts into Jellyfin. Disable to revert to standard UI.
                            <strong>Refresh page</strong> to apply.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="showReviewsCarousel" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Reviews in details pages</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, a carousel of user reviews will be displayed above the Cast & Crew section on
                            movie and TV show details pages.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="versionUiSelect"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Version
                            UI</label>
                        <select id="versionUiSelect"
                            style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                            <option value="carousel">Carousel</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                            Choose UI for version selection.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="audioUiSelect"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Audio
                            UI</label>
                        <select id="audioUiSelect"
                            style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                            <option value="carousel">Carousel</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                            Choose UI for audio track selection.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="subtitleUiSelect"
                            style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Subtitle
                            UI</label>
                        <select id="subtitleUiSelect"
                            style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                            <option value="carousel">Carousel</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                            Choose UI for subtitle selection.
                        </p>
                    </div>
                </div>
            </div>



            <!-- Create Library Confirmation Modal -->
            <div id="createLibraryModal"
                style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                <div
                    style="background: #222; padding: 20px; border-radius: 8px; width: 450px; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                    <h3 style="margin-top: 0; color: #1e90ff;">Create Collection from Catalog?</h3>
                    <p style="color: #ddd; font-size: 14px; line-height: 1.5; margin-bottom: 10px;">
                        You are about to create a new Jellyfin Collection for: <br><strong id="createLibraryName"
                            style="color:white; font-size:16px;"></strong>
                    </p>
                    <p style="color: #aaa; font-size: 13px; margin-bottom: 20px;">
                        This will:<br>
                        1. Create a physical folder.<br>
                        2. Create a virtual collection in Jellyfin.<br>
                        3. Import items from the catalog via Gelato.<br>
                    </p>

                    <label for="createLibraryInputName"
                        style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Collection
                        Name</label>
                    <input id="createLibraryInputName" type="text"
                        style="width:100%;padding:8px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;box-sizing: border-box;">

                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button id="cancelCreateLibBtn"
                            style="padding: 8px 16px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button id="confirmCreateLibBtn"
                            style="padding: 8px 16px; background: #1e90ff; color: white; border: none; border-radius: 4px; cursor: pointer;">Create
                            Collection</button>
                    </div>
                </div>
            </div>

            <!-- Update Preview Modal -->
            <div id="updatePreviewModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                <div
                    style="background: #222; padding: 20px; border-radius: 8px; width: 450px; color: white; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                    <h3 style="margin-top: 0; color: #2ecc71;">Collection Status</h3>

                    <div style="margin: 20px 0; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Existing Items:</span>
                            <span id="previewExisting" style="font-weight: bold; color: #bdc3c7;">Loading...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>New Items (Missing):</span>
                            <span id="previewNew" style="font-weight: bold; color: #2ecc71;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Removed Items (Extra):</span>
                            <span id="previewRemoved" style="font-weight: bold; color: #e74c3c;">-</span>
                        </div>
                        <div
                            style="margin-top: 10px; border-top: 1px solid #444; padding-top: 8px; text-align: center; color: #888; font-size: 0.9em;">
                            Total in Catalog: <span id="previewTotal">-</span>
                        </div>
                    </div>

                    <div id="previewMessage" style="margin-bottom: 20px; text-align: center; font-style: italic;">
                        Checking for updates...
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button id="closePreviewBtn"
                            style="padding: 8px 16px; border: none; background: #555; color: white; border-radius: 4px; cursor: pointer;">Close</button>
                        <button id="confirmUpdateBtn"
                            style="padding: 8px 16px; border: none; background: #2ecc71; color: white; border-radius: 4px; cursor: pointer; display: none;">Update
                            Collection</button>
                    </div>
                </div>
            </div>

            <!-- Delete Single Confirm Modal -->
            <div id="deleteSingleModal"
                style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;justify-content:center;align-items:center;">
                <div
                    style="background:#202020;padding:20px;border-radius:8px;width:90%;max-width:400px;box-shadow:0 0 20px rgba(0,0,0,0.5);">
                    <h3 style="margin-top:0;color:#e74c3c;">Delete Item Cache?</h3>
                    <p id="deleteSingleText" style="color:#ddd;font-size:14px;line-height:1.5;">
                        <!-- Populated by JS -->
                    </p>
                    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                        <button id="cancelSingleDeleteBtn"
                            style="padding:8px 16px;border:none;border-radius:4px;background:#555;color:#fff;cursor:pointer;">Cancel</button>
                        <button id="confirmSingleDeleteBtn"
                            style="padding:8px 16px;border:none;border-radius:4px;background:#e74c3c;color:#fff;cursor:pointer;font-weight:bold;">Delete</button>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px; padding-bottom: 60px;">
                <button id="saveConfigBtn"
                    style="padding:8px 16px;border-radius:4px;border:none;background:#1e90ff;color:#fff;cursor:pointer;font-size:14px;">Save
                    Configuration</button>
                <div id="configStatus" style="margin-top:8px;color:#ccc;font-size:13px;"></div>
            </div>

            <script>
                async function loadConfig() {
                    try {
                        if (window.ApiClient && window.ApiClient.ajax) {
                            let response = await window.ApiClient.ajax({ type: 'GET', url: window.ApiClient.getUrl('api/baklava/config'), dataType: 'json' });
                            if (response && response.constructor && response.constructor.name === 'Response') response = await response.json();
                            document.getElementById('tmdbApiKey').value = response?.tmdbApiKey || '';
                            document.getElementById('forceTVClientLocalSearch').checked = response?.forceTVClientLocalSearch === true;
                            document.getElementById('enableAutoImport').checked = response?.enableAutoImport === true;
                            document.getElementById('disableModal').checked = response?.disableModal === true;
                            document.getElementById('showReviewsCarousel').checked = response?.showReviewsCarousel !== false;
                            document.getElementById('versionUiSelect').value = response?.versionUi || 'carousel';
                            document.getElementById('audioUiSelect').value = response?.audioUi || 'carousel';
                            document.getElementById('subtitleUiSelect').value = response?.subtitleUi || 'carousel';

                            // UI Injection Toggle
                            const val = response?.enableBaklavaUI ?? response?.EnableBaklavaUI;
                            document.getElementById('enableBaklavaUI').checked = (val === undefined) ? true : val;

                            // Multi-debrid API keys
                            document.getElementById('realDebridApiKey').value = response?.realDebridApiKey || response?.debridApiKey || '';
                            document.getElementById('torboxApiKey').value = response?.torboxApiKey || '';
                            document.getElementById('alldebridApiKey').value = response?.alldebridApiKey || '';
                            document.getElementById('premiumizeApiKey').value = response?.premiumizeApiKey || '';
                            document.getElementById('enableDebridMetadata').checked = response?.enableDebridMetadata !== false;
                            document.getElementById('enableFallbackProbe').checked = response?.enableFallbackProbe === true;

                            document.getElementById('fetchCachedMetadataPerVersion').checked = response?.fetchCachedMetadataPerVersion === true;
                            document.getElementById('fetchAllNonCachedMetadata').checked = response?.fetchAllNonCachedMetadata === true;

                            document.getElementById('enableExternalSubtitles').checked = response?.enableExternalSubtitles === true;

                            updateToggles(); // Initial state update
                            loadCacheServices(); // Load available cache services

                            console.log('[Baklava][Config] Loaded config:', response);
                            return;
                        }

                        const url = (window.ApiClient && window.ApiClient.getUrl) ? window.ApiClient.getUrl('api/baklava/config') : (window.location.origin + '/api/baklava/config');
                        const res = await fetch(url, { credentials: 'same-origin' });
                        if (!res.ok) throw new Error('Failed to load config');
                        const json = await res.json();
                        console.log('[Baklava][Config] Raw config response:', json);

                        document.getElementById('tmdbApiKey').value = json.tmdbApiKey || '';
                        document.getElementById('forceTVClientLocalSearch').checked = json.forceTVClientLocalSearch === true;
                        document.getElementById('enableAutoImport').checked = json.enableAutoImport === true;
                        document.getElementById('disableModal').checked = json.disableModal === true;
                        document.getElementById('showReviewsCarousel').checked = json.showReviewsCarousel !== false;
                        document.getElementById('versionUiSelect').value = json.versionUi || 'carousel';
                        document.getElementById('audioUiSelect').value = json.audioUi || 'carousel';
                        document.getElementById('subtitleUiSelect').value = json.subtitleUi || 'carousel';


                        // UI Injection Toggle
                        const val2 = json.enableBaklavaUI ?? json.EnableBaklavaUI;
                        console.log('[Baklava] Loaded raw EnableBaklavaUI:', val2);
                        document.getElementById('enableBaklavaUI').checked = (val2 === undefined) ? true : val2;

                        // Multi-debrid API keys
                        document.getElementById('realDebridApiKey').value = json.realDebridApiKey || json.debridApiKey || '';
                        document.getElementById('torboxApiKey').value = json.torboxApiKey || '';
                        document.getElementById('alldebridApiKey').value = json.alldebridApiKey || '';
                        document.getElementById('premiumizeApiKey').value = json.premiumizeApiKey || '';

                        document.getElementById('enableDebridMetadata').checked = json.enableDebridMetadata !== false;
                        document.getElementById('enableFallbackProbe').checked = json.enableFallbackProbe === true;

                        document.getElementById('fetchCachedMetadataPerVersion').checked = json.fetchCachedMetadataPerVersion === true;
                        document.getElementById('fetchAllNonCachedMetadata').checked = json.fetchAllNonCachedMetadata === true;

                        document.getElementById('enableExternalSubtitles').checked = json.enableExternalSubtitles === true;

                        updateToggles(); // Initial state update
                        loadCacheServices(); // Load available cache services

                        console.log('[Baklava][Config] Config loaded setup complete');
                    } catch (e) {
                        console.error('[Baklava][Config] Load error:', e);
                        document.getElementById('configStatus').textContent = 'Error loading config: ' + e.message;
                    }
                }


                function updateToggles() {
                    const debridEnabled = document.getElementById('enableDebridMetadata').checked;
                    const probeEnabled = document.getElementById('enableFallbackProbe').checked;

                    const cachedToggle = document.getElementById('fetchCachedMetadataPerVersion');
                    cachedToggle.disabled = !debridEnabled;
                    if (!debridEnabled) cachedToggle.parentElement.style.opacity = '0.5';
                    else cachedToggle.parentElement.style.opacity = '1';

                    const nonCachedToggle = document.getElementById('fetchAllNonCachedMetadata');
                    nonCachedToggle.disabled = !probeEnabled;
                    if (!probeEnabled) nonCachedToggle.parentElement.style.opacity = '0.5';
                    else nonCachedToggle.parentElement.style.opacity = '1';
                }

                document.getElementById('enableDebridMetadata').addEventListener('change', updateToggles);
                document.getElementById('enableFallbackProbe').addEventListener('change', updateToggles);

                document.getElementById('saveConfigBtn').addEventListener('click', async () => {
                    const key = document.getElementById('tmdbApiKey').value;
                    const forceTVLocal = document.getElementById('forceTVClientLocalSearch').checked;
                    const enableAutoImport = document.getElementById('enableAutoImport').checked;
                    const disableModal = document.getElementById('disableModal').checked;
                    const showReviewsCarousel = document.getElementById('showReviewsCarousel').checked;
                    const fetchCachedMetadataPerVersion = document.getElementById('fetchCachedMetadataPerVersion').checked;
                    const fetchAllNonCachedMetadata = document.getElementById('fetchAllNonCachedMetadata').checked;
                    const versionUi = document.getElementById('versionUiSelect').value || 'carousel';
                    const audioUi = document.getElementById('audioUiSelect').value || 'carousel';
                    const subtitleUi = document.getElementById('subtitleUiSelect').value || 'carousel';
                    const enableBaklavaUI = document.getElementById('enableBaklavaUI').checked;
                    console.log('[Baklava] Saving EnableBaklavaUI value:', enableBaklavaUI);
                    const debridService = 'realdebrid'; // Multi-service but default to realdebrid for now
                    // Multi-debrid API keys
                    const realDebridApiKey = document.getElementById('realDebridApiKey').value || '';
                    const torboxApiKey = document.getElementById('torboxApiKey').value || '';
                    const alldebridApiKey = document.getElementById('alldebridApiKey').value || '';
                    const premiumizeApiKey = document.getElementById('premiumizeApiKey').value || '';
                    const enableDebridMetadata = document.getElementById('enableDebridMetadata').checked;
                    const enableFallbackProbe = document.getElementById('enableFallbackProbe').checked;
                    const enableExternalSubtitles = document.getElementById('enableExternalSubtitles').checked;


                    const configData = {
                        tmdbApiKey: key,
                        enableSearchFilter: false,
                        forceTVClientLocalSearch: forceTVLocal,
                        enableAutoImport: enableAutoImport,
                        disableModal: disableModal,
                        showReviewsCarousel: showReviewsCarousel,
                        versionUi: versionUi,
                        audioUi: audioUi,
                        subtitleUi: subtitleUi,
                        enableBaklavaUI: enableBaklavaUI,
                        debridService: debridService,
                        debridApiKey: realDebridApiKey, // Backwards compat
                        realDebridApiKey: realDebridApiKey,
                        torboxApiKey: torboxApiKey,
                        alldebridApiKey: alldebridApiKey,
                        premiumizeApiKey: premiumizeApiKey,
                        enableDebridMetadata: enableDebridMetadata,
                        enableFallbackProbe: enableFallbackProbe,
                        fetchCachedMetadataPerVersion: fetchCachedMetadataPerVersion,
                        fetchAllNonCachedMetadata: fetchAllNonCachedMetadata,
                        enableExternalSubtitles: enableExternalSubtitles
                    };

                    try {
                        // Prefer ApiClient.ajax which includes authentication and proper headers
                        if (window.ApiClient && window.ApiClient.ajax) {
                            const ajaxOpts = {
                                type: 'PUT',
                                url: window.ApiClient.getUrl('api/baklava/config'),
                                data: JSON.stringify(configData),
                                contentType: 'application/json'
                            };
                            const res = await window.ApiClient.ajax(ajaxOpts);
                            console.log('[Baklava][Config] ApiClient.ajax PUT result:', res);
                            // Some ApiClient implementations return Response-like objects
                            if (res && ((res.status && res.status === 403) || (res.statusCode && res.statusCode === 403))) {
                                document.getElementById('configStatus').textContent = 'Forbidden: admin only';
                                return;
                            }
                            // If res is a Response-like object, check ok
                            if (res && res.constructor && res.constructor.name === 'Response') {
                                if (!res.ok) {
                                    document.getElementById('configStatus').textContent = 'Error saving configuration';
                                    console.error('[Baklava][Config] PUT failed (Response):', res);
                                    return;
                                }
                            }
                            // Update cached plugin config in page context so client code picks it up immediately
                            try { if (window.MediaServerUI) window.MediaServerUI._pluginConfig = configData; } catch (e) { }
                            document.getElementById('configStatus').textContent = 'Configuration saved successfully!';
                            return;
                        }

                        const url = (window.ApiClient && window.ApiClient.getUrl) ? window.ApiClient.getUrl('api/baklava/config') : (window.location.origin + '/api/baklava/config');
                        const res = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(configData),
                            credentials: 'same-origin'
                        });
                        console.log('[Baklava][Config] fetch PUT result:', res);
                        if (res.status === 403) {
                            document.getElementById('configStatus').textContent = 'Forbidden: admin only';
                            return;
                        }
                        if (!res.ok) throw new Error('Save failed');
                        try { if (window.MediaServerUI) window.MediaServerUI._pluginConfig = configData; } catch (e) { }
                        document.getElementById('configStatus').textContent = 'Configuration saved successfully!';
                    } catch (err) {
                        document.getElementById('configStatus').textContent = 'Error saving configuration';
                        console.error('[Baklava][Config] Save error:', err);
                    }
                });

                loadConfig().catch(err => {
                    console.error('[Baklava][Config] Failed to load config:', err);
                });

                // --- Cache Management Logic ---

                async function loadCacheServices() {
                    try {
                        const url = (window.ApiClient && window.ApiClient.getUrl)
                            ? window.ApiClient.getUrl(`api/baklava/metadata/cache/services`)
                            : (window.location.origin + `/api/baklava/metadata/cache/services`);

                        let services = [];
                        if (window.ApiClient && window.ApiClient.ajax) {
                            let response = await window.ApiClient.ajax({ type: 'GET', url: url, dataType: 'json' });
                            if (response && response.constructor && response.constructor.name === 'Response') response = await response.json();
                            services = response || [];
                        } else {
                            const res = await fetch(url, { credentials: 'same-origin' });
                            if (res.ok) services = await res.json();
                        }

                        const select = document.getElementById('cacheServiceSelect');
                        // Keep "All Services" option, remove dynamic ones
                        while (select.options.length > 1) {
                            select.remove(1);
                        }

                        // Add services with cache
                        services.forEach(function (svc) {
                            var opt = document.createElement('option');
                            opt.value = svc.name;
                            opt.textContent = svc.name + ' (' + svc.fileCount + ' files)';
                            opt.disabled = !svc.hasFiles;
                            select.appendChild(opt);
                        });

                        console.log('[Baklava][Config] Loaded cache services:', services);
                    } catch (e) {
                        console.error('[Baklava][Config] Failed to load cache services:', e);
                    }
                }

                async function loadCacheList() {
                    const container = document.getElementById('cacheListContainer');
                    container.innerHTML = '<div style="text-align: center; color: #888; padding: 10px;">Loading cache...</div>';

                    try {
                        const url = (window.ApiClient && window.ApiClient.getUrl) ? window.ApiClient.getUrl('api/baklava/metadata/cache') : (window.location.origin + '/api/baklava/metadata/cache');
                        let items = [];

                        if (window.ApiClient && window.ApiClient.ajax) {
                            items = await window.ApiClient.ajax({ type: 'GET', url: url, dataType: 'json' });
                        } else {
                            const res = await fetch(url);
                            if (res.ok) items = await res.json();
                        }

                        if (!Array.isArray(items) || items.length === 0) {
                            container.innerHTML = '<div style="text-align: center; color: #888; padding: 10px;">No cached items found.</div>';
                            return;
                        }

                        container.innerHTML = '';
                        items.forEach(item => {
                            const row = document.createElement('div');
                            row.style.display = 'flex';
                            row.style.justifyContent = 'space-between';
                            row.style.alignItems = 'center';
                            row.style.padding = '8px';
                            row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';

                            const info = document.createElement('div');
                            var sizeText = (item.size / 1024).toFixed(1) + ' KB';
                            info.innerHTML = '<strong style="color: #ddd; font-size: 14px;">' + (item.title || 'Unknown Title') + '</strong><br>' +
                                '<span style="font-size: 11px; color: #888;">ID: ' + item.id + ' â€¢ Size: ' + sizeText + '</span>';

                            const actions = document.createElement('div');
                            actions.style.display = 'flex';
                            actions.style.gap = '8px';

                            const refreshBtn = document.createElement('button');
                            refreshBtn.textContent = 'Refresh';
                            refreshBtn.style.padding = '4px 8px';
                            refreshBtn.style.background = '#1e90ff';
                            refreshBtn.style.color = 'white';
                            refreshBtn.style.border = 'none';
                            refreshBtn.style.borderRadius = '3px';
                            refreshBtn.style.cursor = 'pointer';
                            refreshBtn.style.fontSize = '12px';
                            refreshBtn.onclick = () => refreshCacheItem(item.id, refreshBtn);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.style.padding = '4px 8px';
                            deleteBtn.style.background = '#e74c3c';
                            deleteBtn.style.color = 'white';
                            deleteBtn.style.border = 'none';
                            deleteBtn.style.borderRadius = '3px';
                            deleteBtn.style.cursor = 'pointer';
                            deleteBtn.style.fontSize = '12px';
                            deleteBtn.onclick = () => showSingleDeleteModal(item.id, item.title || 'Unknown Title');

                            actions.appendChild(refreshBtn);
                            actions.appendChild(deleteBtn);
                            row.appendChild(info);
                            row.appendChild(actions);
                            container.appendChild(row);
                        });

                    } catch (e) {
                        console.error('Failed to load cache list', e);
                        container.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 10px;">Failed to load cache list. See console.</div>';
                    }
                }

                async function deleteCacheItem(itemId) {
                    try {
                        const url = (window.ApiClient && window.ApiClient.getUrl)
                            ? window.ApiClient.getUrl('api/baklava/metadata/cache/' + itemId)
                            : (window.location.origin + '/api/baklava/metadata/cache/' + itemId);

                        if (window.ApiClient && window.ApiClient.ajax) {
                            await window.ApiClient.ajax({ type: 'DELETE', url: url });
                        } else {
                            await fetch(url, { method: 'DELETE' });
                        }

                        // Reload list
                        loadCacheList();

                    } catch (e) {
                        console.error('Delete failed', e);
                        // Show error details if available
                        alert('Failed to delete item. ' + (e.message || 'Check console.'));
                    }
                }


                async function refreshCacheItem(itemId, btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '...';
                    btn.disabled = true;

                    try {
                        const url = (window.ApiClient && window.ApiClient.getUrl)
                            ? window.ApiClient.getUrl('api/baklava/metadata/cache/' + itemId + '/refresh')
                            : (window.location.origin + '/api/baklava/metadata/cache/' + itemId + '/refresh');

                        if (window.ApiClient && window.ApiClient.ajax) {
                            await window.ApiClient.ajax({ type: 'POST', url: url });
                        } else {
                            await fetch(url, { method: 'POST' });
                        }

                        btn.textContent = 'Done!';
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                            loadCacheList(); // Refresh metadata size/time
                        }, 1000);
                    } catch (e) {
                        console.error('Refresh failed', e);
                        btn.textContent = 'Err';
                        btn.style.background = '#555';
                        alert('Failed to refresh item. Check console.');
                    }
                }

                // Modal Logic
                const modal = document.getElementById('deleteConfirmModal');
                const clearBtn = document.getElementById('clearAllCacheBtn');
                const probeBtn = document.getElementById('probeAllCacheBtn'); // New Button
                const cancelBtn = document.getElementById('cancelDeleteBtn');
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const probeConfirmModal = document.getElementById('probeConfirmModal'); // New Modal
                const cancelProbeBtn = document.getElementById('cancelProbeBtn');
                const confirmProbeBtn = document.getElementById('confirmProbeBtn');

                clearBtn.onclick = () => { modal.style.display = 'flex'; };
                cancelBtn.onclick = () => { modal.style.display = 'none'; };

                probeBtn.onclick = () => { probeConfirmModal.style.display = 'flex'; };
                cancelProbeBtn.onclick = () => { probeConfirmModal.style.display = 'none'; };

                confirmBtn.onclick = async () => {
                    modal.style.display = 'none';
                    confirmBtn.textContent = 'Deleting...';
                    try {
                        const selectedService = document.getElementById('cacheServiceSelect').value;
                        const serviceParam = selectedService ? `?service=${encodeURIComponent(selectedService)}` : '';
                        const url = (window.ApiClient && window.ApiClient.getUrl)
                            ? window.ApiClient.getUrl(`api/baklava/metadata/cache`) + serviceParam
                            : (window.location.origin + `/api/baklava/metadata/cache` + serviceParam);

                        if (window.ApiClient && window.ApiClient.ajax) {
                            await window.ApiClient.ajax({ type: 'DELETE', url: url });
                        } else {
                            await fetch(url, { method: 'DELETE' });
                        }

                        loadCacheList();
                        loadCacheServices(); // Refresh service dropdown
                    } catch (e) {
                        console.error('Delete All failed', e);
                        alert('Failed to delete all items.');
                    } finally {
                        confirmBtn.textContent = 'Yes, Delete All';
                    }
                };

                confirmProbeBtn.onclick = async () => {
                    const originalText = confirmProbeBtn.textContent;
                    confirmProbeBtn.textContent = 'Starting...';
                    confirmProbeBtn.disabled = true;
                    cancelProbeBtn.style.display = 'none';

                    try {
                        const url = (window.ApiClient && window.ApiClient.getUrl)
                            ? window.ApiClient.getUrl(`api/baklava/metadata/cache/probe-all`)
                            : (window.location.origin + `/api/baklava/metadata/cache/probe-all`);

                        if (window.ApiClient && window.ApiClient.ajax) {
                            await window.ApiClient.ajax({ type: 'POST', url: url });
                        } else {
                            await fetch(url, { method: 'POST' });
                        }

                        // Success Feedback in Modal
                        const contentDiv = probeConfirmModal.querySelector('div');
                        contentDiv.innerHTML = `
                            <h3 style="margin-top: 0; color: #2ecc71;">Probe Started</h3>
                            <p style="color: #ddd; font-size: 14px; line-height: 1.5;">
                                The background probe process has successfully started.<br><br>
                                Please check your <strong>Jellyfin Server Logs</strong> to monitor progress.<br><br>
                                You can close this window.
                            </p>
                            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                                <button id="closeProbeModalBtn"
                                    style="padding: 8px 16px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                            </div>
                        `;
                        const closeBtn = document.getElementById('closeProbeModalBtn');
                        closeBtn.onclick = () => {
                            probeConfirmModal.style.display = 'none';
                            // Reset modal content for next time (optional, but good practice if not reloading page)
                            // Ideally we reload or reset, but for now simple close is fine. 
                            window.location.reload();
                        };

                    } catch (e) {
                        console.error('Probe All failed', e);
                        confirmProbeBtn.textContent = 'Failed';
                        confirmProbeBtn.style.background = '#e74c3c';
                        alert('Failed to start probe.');
                        setTimeout(() => {
                            probeConfirmModal.style.display = 'none';
                            confirmProbeBtn.textContent = originalText;
                            confirmProbeBtn.disabled = false;
                            confirmProbeBtn.style.background = '#1e90ff';
                            cancelProbeBtn.style.display = 'inline-block';
                        }, 2000);
                    }
                };

                // Single Delete Modal Logic
                const singleModal = document.getElementById('deleteSingleModal');
                const cancelSingleBtn = document.getElementById('cancelSingleDeleteBtn');
                const confirmSingleBtn = document.getElementById('confirmSingleDeleteBtn');
                let currentDeleteId = null;

                function showSingleDeleteModal(id, title) {
                    currentDeleteId = id;
                    const textEl = document.getElementById('deleteSingleText');
                    textEl.innerHTML = 'Are you sure you want to delete cached metadata for <strong>' + (title || 'Unknown') + '</strong>?<br><br>' +
                        'This will also attempt to delete the download from your Debrid provider.';
                    singleModal.style.display = 'flex';
                }

                cancelSingleBtn.onclick = () => {
                    singleModal.style.display = 'none';
                    currentDeleteId = null;
                };

                confirmSingleBtn.onclick = async () => {
                    if (!currentDeleteId) return;
                    confirmSingleBtn.disabled = true;
                    confirmSingleBtn.textContent = 'Deleting...';

                    await deleteCacheItem(currentDeleteId);

                    singleModal.style.display = 'none';
                    confirmSingleBtn.disabled = false;
                    confirmSingleBtn.textContent = 'Delete';
                    currentDeleteId = null;
                };

                // Load cache list on startup
                loadCacheList();

                // --- Catalogs Management ---
                const CATALOGS_API = 'api/baklava/catalogs';
                let catalogsData = [];
                let catalogFilter = 'all'; // 'all', 'imported', 'not-imported'

                // Filter dropdown toggle
                document.getElementById('catalogFilterBtn').addEventListener('click', function (e) {
                    e.stopPropagation();
                    const dropdown = document.getElementById('catalogFilterDropdown');
                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function () {
                    document.getElementById('catalogFilterDropdown').style.display = 'none';
                });

                // Filter option selection
                document.querySelectorAll('.catalog-filter-option').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        catalogFilter = this.dataset.filter;
                        document.querySelectorAll('.catalog-filter-option').forEach(b => b.style.background = 'transparent');
                        this.style.background = 'rgba(30,144,255,0.3)';
                        const labels = { 'all': 'All', 'imported': 'Imported', 'not-imported': 'Not Imported' };
                        document.getElementById('catalogFilterLabel').textContent = '(' + labels[catalogFilter] + ')';
                        document.getElementById('catalogFilterDropdown').style.display = 'none';
                        renderCatalogs();
                    });
                });

                async function loadCatalogs() {
                    const loading = document.getElementById('catalogsLoading');
                    const error = document.getElementById('catalogsError');
                    const list = document.getElementById('catalogsList');

                    loading.style.display = 'block';
                    error.style.display = 'none';
                    list.innerHTML = '';

                    try {
                        const url = (window.ApiClient && window.ApiClient.getUrl)
                            ? window.ApiClient.getUrl(CATALOGS_API)
                            : (window.location.origin + '/' + CATALOGS_API);

                        let response;
                        if (window.ApiClient && window.ApiClient.ajax) {
                            response = await window.ApiClient.ajax({ type: 'GET', url: url, dataType: 'json' });
                            if (response && response.constructor && response.constructor.name === 'Response') {
                                response = await response.json();
                            }
                        } else {
                            const res = await fetch(url, { credentials: 'same-origin' });
                            if (!res.ok) throw new Error('Failed to fetch catalogs');
                            response = await res.json();
                        }

                        catalogsData = response || [];
                        renderCatalogs();
                    } catch (e) {
                        console.error('[Baklava] Failed to load catalogs:', e);
                        error.textContent = 'Failed to load catalogs: ' + e.message;
                        error.style.display = 'block';
                    } finally {
                        loading.style.display = 'none';
                    }
                }

                function renderCatalogs() {
                    const list = document.getElementById('catalogsList');
                    if (catalogsData.length === 0) {
                        list.innerHTML = '<div style="padding: 16px; text-align: center; color: #888;">No catalogs found. Make sure Gelato is configured with a valid aiostreams manifest.</div>';
                        return;
                    }

                    console.log('[Baklava] Rendering catalogs:', catalogsData);

                    let html = '';
                    for (let i = 0; i < catalogsData.length; i++) {
                        const cat = catalogsData[i];

                        // Apply filter
                        const isImported = !!cat.existingCollectionId;
                        if (catalogFilter === 'imported' && !isImported) continue;
                        if (catalogFilter === 'not-imported' && isImported) continue;

                        const icon = cat.type === 'series' ? 'ðŸ“º' : 'ðŸŽ¬';
                        const name = escapeHtml(cat.name || cat.id || 'Unknown');
                        const type = escapeHtml(cat.type || 'unknown');
                        const count = cat.itemCount >= 0 ? cat.itemCount + ' titles' : '';
                        const source = cat.addonName ? ' â€¢ ' + escapeHtml(cat.addonName) : '';
                        const catId = escapeHtml(cat.id || '');
                        const sourceUrl = cat.sourceUrl || '';
                        const searchText = (name + ' ' + (cat.addonName || '')).toLowerCase();

                        html += '<div class="catalog-item" data-search="' + escapeHtml(searchText) + '" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-radius: 8px;">';
                        html += '<div style="flex: 1;">';
                        html += '<div style="font-size: 1rem; font-weight: 500; display: flex; align-items: center; gap: 8px;">';
                        html += '<span style="font-size: 1.2em;">' + icon + '</span>';
                        html += name;
                        html += '<span style="font-size: 0.7em; padding: 2px 6px; background: #1e90ff; color: white; border-radius: 4px; text-transform: uppercase;">' + type + '</span>';
                        if (sourceUrl) {
                            html += '<a href="' + escapeHtml(sourceUrl) + '" target="_blank" rel="noopener" style="text-decoration: none; color: #1e90ff; font-size: 1.1em; margin-left: 4px;" title="Open source page">ðŸ”—</a>';
                        }
                        html += '</div>';
                        html += '<div style="font-size: 0.85em; color: #888; margin-top: 4px;">' + count + source + '</div>';
                        html += '</div>';
                        const existingId = cat.existingCollectionId;
                        const btnText = existingId ? 'Update Collection' : 'Create Collection';
                        const btnBg = existingId ? '#2ecc71' : '#1e90ff';

                        html += '<div style="display: flex; gap: 8px;">';
                        html += '<button type="button" data-action="import" data-id="' + catId + '" data-type="' + type + '" data-name="' + name + '" data-existing="' + (existingId || '') + '" style="padding: 6px 12px; border: none; background: ' + btnBg + '; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">' + btnText + '</button>';
                        html += '</div>';
                        html += '</div>';
                    }
                    list.innerHTML = html;

                    // Add event listeners for buttons

                    list.querySelectorAll('button[data-action="import"]').forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            if (this.dataset.existing) {
                                openUpdatePreviewModal(this.dataset.id, this.dataset.type, this.dataset.name);
                            } else {
                                openCreateLibraryModal(this.dataset.id, this.dataset.type, this.dataset.name);
                            }
                        });
                    });
                }

                function escapeHtml(str) {
                    if (!str) return '';
                    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                }


                // --- Create Library Modal Logic ---
                const createLibModal = document.getElementById('createLibraryModal');
                const createLibNameDisplay = document.getElementById('createLibraryName');
                const createLibInputName = document.getElementById('createLibraryInputName');
                const cancelCreateLibBtn = document.getElementById('cancelCreateLibBtn');
                const confirmCreateLibBtn = document.getElementById('confirmCreateLibBtn');

                let currentCatalogId = null;
                let currentCatalogType = null;
                let currentCatalogName = null;

                cancelCreateLibBtn.onclick = () => { createLibModal.style.display = 'none'; };

                function openCreateLibraryModal(catId, catType, catName) {
                    currentCatalogId = catId;
                    currentCatalogType = catType;
                    currentCatalogName = catName;

                    createLibNameDisplay.textContent = catName;
                    createLibInputName.value = catName;

                    confirmCreateLibBtn.textContent = 'Create Collection';
                    confirmCreateLibBtn.disabled = false;

                    createLibModal.style.display = 'flex';
                }

                confirmCreateLibBtn.onclick = async () => {
                    const libName = createLibInputName.value || currentCatalogName;

                    confirmCreateLibBtn.textContent = 'Creating...';
                    confirmCreateLibBtn.disabled = true;

                    try {
                        await importCatalog(currentCatalogId, currentCatalogType, currentCatalogName, libName);
                        createLibModal.style.display = 'none';
                    } catch (e) {
                        Dashboard.alert({ message: 'Error: ' + e.message, title: 'Error' });
                        confirmCreateLibBtn.textContent = 'Retry';
                        confirmCreateLibBtn.disabled = false;
                    }
                };

                async function importCatalog(catalogId, catalogType, catalogName, libraryName) {
                    // if (!confirm('Create a new Jellyfin library for "' + catalogName + '"? This will create a library and import up to 100 items.')) return;

                    const url = (window.ApiClient && window.ApiClient.getUrl)
                        ? window.ApiClient.getUrl(CATALOGS_API + '/' + encodeURIComponent(catalogId) + '/library') + '?type=' + catalogType
                        : (window.location.origin + '/' + CATALOGS_API + '/' + encodeURIComponent(catalogId) + '/library?type=' + catalogType);

                    try {
                        let response;
                        const maxItems = parseInt(document.getElementById('catalogsMaxItems')?.value) || 100;
                        const payload = JSON.stringify({ maxItems: maxItems, libraryName: libraryName });

                        if (window.ApiClient && window.ApiClient.ajax) {
                            response = await window.ApiClient.ajax({
                                type: 'POST',
                                url: url,
                                data: payload,
                                contentType: 'application/json'
                            });
                            if (response && response.constructor && response.constructor.name === 'Response') {
                                response = await response.json();
                            }
                        } else {
                            const res = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: payload,
                                credentials: 'same-origin'
                            });
                            response = await res.json();
                        }

                        if (response && response.success) {
                            Dashboard.alert({ message: 'Collection "' + response.libraryName + '" created! Items are being imported in the background.', title: 'Import Started' });
                        } else {
                            const msg = response?.message || 'Unknown error';
                            throw new Error(msg);
                        }
                    } catch (e) {
                        console.error(e);
                        throw e;
                    }
                }

                // --- Update Preview Modal Logic ---
                const updatePreviewModal = document.getElementById('updatePreviewModal');
                const closePreviewBtn = document.getElementById('closePreviewBtn');
                const confirmUpdateBtn = document.getElementById('confirmUpdateBtn');
                const previewExisting = document.getElementById('previewExisting');
                const previewNew = document.getElementById('previewNew');
                const previewRemoved = document.getElementById('previewRemoved');
                const previewTotal = document.getElementById('previewTotal');
                const previewMessage = document.getElementById('previewMessage');

                let previewCatalogId, previewType, previewName;

                closePreviewBtn.onclick = () => { updatePreviewModal.style.display = 'none'; };

                async function openUpdatePreviewModal(catId, catType, catName) {
                    previewCatalogId = catId;
                    previewType = catType;
                    previewName = catName;

                    // Reset UI
                    updatePreviewModal.style.display = 'flex';
                    confirmUpdateBtn.style.display = 'none';
                    previewExisting.textContent = 'Loading...';
                    previewNew.textContent = '-';
                    previewRemoved.textContent = '-';
                    previewTotal.textContent = '-';
                    previewMessage.textContent = 'Comparing catalog with collection...';
                    previewMessage.style.color = '#bdc3c7';

                    try {
                        const maxItems = parseInt(document.getElementById('catalogsMaxItems')?.value) || 100;
                        const url = (window.ApiClient && window.ApiClient.getUrl)
                            ? window.ApiClient.getUrl(CATALOGS_API + '/' + encodeURIComponent(catId) + '/preview-update') + '?type=' + catType
                            : (window.location.origin + '/' + CATALOGS_API + '/' + encodeURIComponent(catId) + '/preview-update?type=' + catType);

                        const payload = JSON.stringify({ maxItems: maxItems });

                        let response;
                        if (window.ApiClient && window.ApiClient.ajax) {
                            response = await window.ApiClient.ajax({
                                type: 'POST',
                                url: url,
                                data: payload,
                                contentType: 'application/json'
                            });
                            if (response && response.constructor && response.constructor.name === 'Response') {
                                response = await response.json();
                            }
                        } else {
                            const res = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: payload,
                                credentials: 'same-origin'
                            });
                            response = await res.json();
                        }

                        // Update Stats
                        previewExisting.textContent = response.existingItems;
                        previewNew.textContent = response.newItems;
                        previewRemoved.textContent = response.removedItems;
                        previewTotal.textContent = response.totalCatalogItems;

                        if (response.newItems > 0 || response.removedItems > 0) {
                            previewMessage.textContent = `Updates available: ${response.newItems} new items found.`;
                            previewMessage.style.color = '#2ecc71';
                            confirmUpdateBtn.style.display = 'block';
                            confirmUpdateBtn.textContent = 'Update Collection';
                            confirmUpdateBtn.disabled = false;
                        } else {
                            previewMessage.textContent = 'Collection is up to date!';
                            previewMessage.style.color = '#3498db';
                        }

                    } catch (e) {
                        previewMessage.textContent = 'Error checking for updates: ' + e.message;
                        previewMessage.style.color = '#e74c3c';
                    }
                }

                confirmUpdateBtn.onclick = async () => {
                    confirmUpdateBtn.textContent = 'Updating...';
                    confirmUpdateBtn.disabled = true;
                    try {
                        // Reuse importCatalog which does add-only logic for now
                        await importCatalog(previewCatalogId, previewType, previewName, null);
                        updatePreviewModal.style.display = 'none';
                    } catch (e) {
                        Dashboard.alert({ message: 'Error: ' + e.message, title: 'Error' });
                        confirmUpdateBtn.disabled = false;
                    }
                };

                document.getElementById('catalogsRefreshBtn').addEventListener('click', loadCatalogs);

                // Load saved max items from localStorage
                const maxItemsInput = document.getElementById('catalogsMaxItems');
                const savedMaxItems = localStorage.getItem('baklava_catalog_max_items');
                if (savedMaxItems && maxItemsInput) {
                    maxItemsInput.value = savedMaxItems;
                }

                // Save max items to localStorage on change
                // Save max items to localStorage on change
                if (maxItemsInput) {
                    maxItemsInput.addEventListener('change', function () {
                        localStorage.setItem('baklava_catalog_max_items', this.value);
                    });
                }

                // Search Filter Logic
                const searchInput = document.getElementById('catalogSearchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', function (e) {
                        const term = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('.catalog-item');
                        rows.forEach(function (row) {
                            const searchVal = row.getAttribute('data-search') || '';
                            row.style.display = searchVal.indexOf(term) > -1 ? 'flex' : 'none';
                        });
                    });
                }

                loadCatalogs(); // Load on startup

            </script>
        </div>
    </div>
    </div>

    <script type="text/javascript">
        console.log('[Baklava] Configuration page loaded');
    </script>
</body>

</html>